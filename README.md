# DocExt - AI-Powered Document Intelligence Platform

A production-grade Next.js application leveraging Supabase Edge Functions and Azure Document Intelligence to automatically extract structured data from documents with high accuracy.

## ğŸ¯ Overview

DocExt is an enterprise-ready document extraction platform that transforms unstructured documents (PDFs, images) into structured, actionable data using advanced AI. The platform provides:

- **ğŸ¤– Intelligent Extraction**: Azure Document Intelligence AI automatically identifies and extracts fields
- **ğŸ“„ Multi-Format Support**: Process PDFs, images (PNG, JPG), and scanned documents
- **ğŸ”’ Enterprise Security**: Row-level security, user isolation, OAuth authentication
- **âš¡ Real-time Processing**: Live status updates with async document processing
- **âœï¸ Manual Validation**: Edit, verify, and correct AI-extracted values
- **ğŸ¨ Modern UI**: Dark/light mode, responsive design, skeleton loading states
- **ğŸ”„ Reprocessing**: Re-extract all fields or add new fields dynamically
- **ğŸ“Š Dashboard Analytics**: Document statistics, processing status, success rates

## ğŸ—ï¸ Architecture Overview

### System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT (Next.js 16)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Pages   â”‚  â”‚Componentsâ”‚  â”‚  Hooks   â”‚  â”‚   Lib    â”‚       â”‚
â”‚  â”‚ - Home   â”‚  â”‚ - Navbar â”‚  â”‚ - Sessionâ”‚  â”‚ - Client â”‚       â”‚
â”‚  â”‚ - Auth   â”‚  â”‚ - Cards  â”‚  â”‚ - Drop   â”‚  â”‚ - Server â”‚       â”‚
â”‚  â”‚ - Dash   â”‚  â”‚ - Modal  â”‚  â”‚  Zone    â”‚  â”‚ - Edge   â”‚       â”‚
â”‚  â”‚ - Docs   â”‚  â”‚ - Theme  â”‚  â”‚          â”‚  â”‚  Funcs   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTPS + JWT Auth
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUPABASE PLATFORM                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              EDGE FUNCTIONS (Deno Runtime)                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚upload-document  â”‚  â”‚process-document â”‚  â”‚get-data   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Validate user â”‚  â”‚ - Azure API callâ”‚  â”‚ - Fetch   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Generate URL  â”‚  â”‚ - Poll results  â”‚  â”‚   results â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Return signed â”‚  â”‚ - Save to DB    â”‚  â”‚ - Format  â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  POSTGRESQL DATABASE                       â”‚ â”‚
â”‚  â”‚  Tables: profiles, documents, document_fields,            â”‚ â”‚
â”‚  â”‚          extracted_data                                    â”‚ â”‚
â”‚  â”‚  RLS Policies: User-scoped access control                 â”‚ â”‚
â”‚  â”‚  Triggers: Auto-create profiles, update timestamps        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    STORAGE BUCKETS                         â”‚ â”‚
â”‚  â”‚  documents/ - User-scoped file storage                    â”‚ â”‚
â”‚  â”‚  Format: {user_id}/{filename}                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   AUTH SYSTEM                              â”‚ â”‚
â”‚  â”‚  Email/Password, Google OAuth, GitHub OAuth              â”‚ â”‚
â”‚  â”‚  JWT tokens, Session management                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTPS + API Key
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AZURE DOCUMENT INTELLIGENCE                        â”‚
â”‚  Model: prebuilt-invoice                                        â”‚
â”‚  - Async document analysis                                      â”‚
â”‚  - Field extraction with confidence scores                      â”‚
â”‚  - Support for invoices, receipts, forms                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› ï¸ Technology Stack

| Layer | Technology | Purpose |
|-------|-----------|---------|
| **Frontend Framework** | Next.js 16 (App Router) | Server/Client components, routing, SSR |
| **UI Library** | React 19 | Component-based UI, hooks, suspense |
| **Language** | TypeScript | Type safety, better DX |
| **Styling** | Tailwind CSS v4 | Utility-first CSS, dark mode |
| **UI Components** | Shadcn UI + Radix UI | Accessible, customizable components |
| **Icons** | Lucide React | Modern icon library |
| **Backend Runtime** | Supabase Edge Functions (Deno) | Serverless functions |
| **Database** | PostgreSQL 15+ | Relational data, ACID compliance |
| **Auth** | Supabase Auth | Email, OAuth (Google/GitHub) |
| **Storage** | Supabase Storage | S3-compatible file storage |
| **AI/ML** | Azure Document Intelligence | Document analysis, field extraction |
| **Form Validation** | Zod | Runtime schema validation |
| **State Management** | React useState/useEffect | Client-side state |
| **Session Management** | Custom hooks | Activity tracking, timeout warnings |
| **Theme** | next-themes | Dark/light mode with persistence |

## ğŸ“Š Complete Application Workflow

### 1. User Registration & Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User visits /auth/sign-up or /auth/login                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                              â”‚
    Email/Password                 OAuth (Google/GitHub)
         â”‚                              â”‚
         â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Auth       â”‚        â”‚ OAuth Provider   â”‚
â”‚ - Create account    â”‚        â”‚ - Authenticate   â”‚
â”‚ - Send confirm emailâ”‚        â”‚ - Return token   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                            â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ Database Trigger:      â”‚
           â”‚ handle_new_user()      â”‚
           â”‚ - Creates profile      â”‚
           â”‚ - Sets username        â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ Redirect to /dashboard â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Files Involved:**
- `/app/auth/sign-up/page.tsx` - Registration UI
- `/app/auth/login/page.tsx` - Login UI
- `/app/auth/callback/route.ts` - OAuth callback handler
- `/lib/client.ts` - Supabase client initialization
- `DATABASE_SETUP.sql` - Trigger definition

**Functions Called:**
1. `supabase.auth.signUp()` - Creates new user account
2. `supabase.auth.signInWithPassword()` - Email/password login
3. `supabase.auth.signInWithOAuth()` - OAuth login
4. Database trigger `handle_new_user()` - Auto-creates profile

---

### 2. Document Upload & Processing Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: User navigates to /extract                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Enter document name                                     â”‚
â”‚ Component: ExtractPage - Step "name"                            â”‚
â”‚ Validation: Zod schema (extractionNameSchema)                   â”‚
â”‚ - Min 1 char, max 100 chars, no leading/trailing spaces         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Upload file(s)                                          â”‚
â”‚ Component: ExtractPage - Step "upload"                          â”‚
â”‚ - Drag & drop or file picker                                    â”‚
â”‚ - Validation: Max 50MB per file, PDF/Image formats              â”‚
â”‚ - Multiple files supported                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Configure fields to extract                             â”‚
â”‚ Component: ExtractPage - Step "fields"                          â”‚
â”‚ Options:                                                         â”‚
â”‚  A) Quick Start - Common invoice fields (17 pre-defined)        â”‚
â”‚  B) Custom Fields - Add individual fields with types            â”‚
â”‚                                                                  â”‚
â”‚ Field Types: text, number, currency, date, email, phone, bool   â”‚
â”‚ Validation: Zod schema (fieldExtractionSchema)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Click "Extract Data" button                             â”‚
â”‚ Function: handleExtract()                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: Upload file to storage                                  â”‚
â”‚ Function: uploadDocument(file, documentName)                    â”‚
â”‚ Location: /lib/edge-functions.ts                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function:       â”‚        â”‚ Return Data:         â”‚
â”‚ upload-document-     â”‚        â”‚ - uploadUrl (signed) â”‚
â”‚ backend              â”‚        â”‚ - filePath           â”‚
â”‚                      â”‚        â”‚ - publicUrl          â”‚
â”‚ Actions:             â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ 1. Validate user JWT â”‚                 â”‚
â”‚ 2. Generate unique   â”‚                 â”‚
â”‚    file path         â”‚                 â”‚
â”‚ 3. Create signed URL â”‚                 â”‚
â”‚    (5min expiry)     â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
         â”‚                               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 7: Client uploads file to signed URL                       â”‚
â”‚ Method: PUT request with file binary                            â”‚
â”‚ Headers: Content-Type, x-upsert                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 8: Process document                                        â”‚
â”‚ Function: processDocument(params)                               â”‚
â”‚ Location: /lib/edge-functions.ts                                â”‚
â”‚                                                                  â”‚
â”‚ Parameters:                                                      â”‚
â”‚ - documentName: string                                          â”‚
â”‚ - filePath: string (storage path)                               â”‚
â”‚ - publicUrl: string (HTTPS URL)                                 â”‚
â”‚ - fieldsToExtract: Array<{name, type, description}>            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function: process-document-backend                         â”‚
â”‚ Location: /supabase/functions/process-document-backend/index.tsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sub-Step 8.1:        â”‚        â”‚ Sub-Step 8.2:        â”‚
â”‚ Create DB Records    â”‚        â”‚ Call Azure AI        â”‚
â”‚                      â”‚        â”‚                      â”‚
â”‚ 1. Insert document   â”‚        â”‚ 1. POST to Azure     â”‚
â”‚    record            â”‚        â”‚    endpoint          â”‚
â”‚    - user_id         â”‚        â”‚ 2. Send publicUrl    â”‚
â”‚    - name            â”‚        â”‚ 3. Get operation ID  â”‚
â”‚    - storage_path    â”‚        â”‚ 4. Poll for results  â”‚
â”‚    - status:         â”‚        â”‚    (max 60s, 1s      â”‚
â”‚      "processing"    â”‚        â”‚     intervals)       â”‚
â”‚                      â”‚        â”‚ 5. Extract fields    â”‚
â”‚ 2. Insert fields     â”‚        â”‚    from response     â”‚
â”‚    records (batch)   â”‚        â”‚                      â”‚
â”‚    - document_id     â”‚        â”‚                      â”‚
â”‚    - name            â”‚        â”‚                      â”‚
â”‚    - type            â”‚        â”‚                      â”‚
â”‚    - description     â”‚        â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sub-Step 8.3: Save extracted data                               â”‚
â”‚                                                                  â”‚
â”‚ For each field in Azure response:                               â”‚
â”‚ 1. Find matching field by name (case-insensitive)               â”‚
â”‚ 2. Extract value and confidence score                           â”‚
â”‚ 3. Insert into extracted_data table                             â”‚
â”‚    - document_id                                                 â”‚
â”‚    - field_id                                                    â”‚
â”‚    - value                                                       â”‚
â”‚    - confidence                                                  â”‚
â”‚                                                                  â”‚
â”‚ 4. Update document status to "completed"                        â”‚
â”‚ 5. Trigger updates processed_at timestamp                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 9: Redirect to /dashboard                                  â”‚
â”‚ User sees document in list with "completed" status              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Files Involved:**
- `/app/extract/page.tsx` - Main upload UI
- `/lib/edge-functions.ts` - Client-side API helpers
- `/lib/validations.ts` - Zod schemas
- `/supabase/functions/upload-document-backend/index.ts` - Upload handler
- `/supabase/functions/process-document-backend/index.ts` - Processing handler

**Key Functions:**

1. **Client-Side (`/app/extract/page.tsx`):**
   - `handleNameSubmit()` - Validates document name
   - `handleFileSelect()` - Validates and stores files
   - `handleAddField()` - Adds custom extraction field
   - `handleQuickStart()` - Loads common invoice fields
   - `handleExtract()` - Orchestrates upload and processing

2. **API Layer (`/lib/edge-functions.ts`):**
   - `uploadDocument(file, documentName)` - Handles file upload
   - `processDocument(params)` - Triggers extraction
   - `callEdgeFunction(name, payload)` - Generic edge function caller

3. **Edge Functions:**
   - `upload-document-backend` - Generates signed upload URL
   - `process-document-backend` - Calls Azure AI, saves results

---

### 3. View & Manage Documents Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User navigates to /dashboard                                    â”‚
â”‚ Component: DashboardPage (Server Component)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Server Component: DashboardDataWrapper                          â”‚
â”‚                                                                  â”‚
â”‚ 1. Get authenticated user from Supabase Auth                    â”‚
â”‚    Function: supabase.auth.getUser()                            â”‚
â”‚                                                                  â”‚
â”‚ 2. Fetch user's documents from database                         â”‚
â”‚    Function: fetchDashboardData(userId)                         â”‚
â”‚    Query: SELECT * FROM documents WHERE user_id = $1            â”‚
â”‚          ORDER BY created_at DESC                               â”‚
â”‚                                                                  â”‚
â”‚ 3. Calculate statistics:                                        â”‚
â”‚    - total: Total document count                                â”‚
â”‚    - completed: Status = "completed"                            â”‚
â”‚    - processing: Status = "processing"                          â”‚
â”‚    - failed: Status = "failed"                                  â”‚
â”‚    - successRate: (completed / total) * 100                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client Component: DashboardContent                              â”‚
â”‚                                                                  â”‚
â”‚ Displays:                                                        â”‚
â”‚ - Stats cards (Total, Completed, Processing, Success Rate)      â”‚
â”‚ - Search bar (filters by name)                                  â”‚
â”‚ - Status filter (All, Completed, Processing, Failed)            â”‚
â”‚ - Document grid (DocumentCard components)                       â”‚
â”‚                                                                  â”‚
â”‚ Features:                                                        â”‚
â”‚ - Real-time search filtering                                    â”‚
â”‚ - Status-based filtering                                        â”‚
â”‚ - Delete document functionality                                 â”‚
â”‚ - Navigate to document details                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Files Involved:**
- `/app/dashboard/page.tsx` - Server component wrapper
- `/app/dashboard/dashboard-content.tsx` - Client component UI
- `/components/document-card.tsx` - Individual document display
- `/lib/server.ts` - Server-side Supabase client

---

### 4. Document Detail & Field Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User clicks on document from dashboard                          â”‚
â”‚ Navigate to /documents/[id]                                     â”‚
â”‚ Component: DocumentDetailPage                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: Fetch document details                                  â”‚
â”‚ Function: fetchData()                                           â”‚
â”‚                                                                  â”‚
â”‚ Edge Function Call: get-extracted-data-backend                  â”‚
â”‚ Parameters: { documentId: string }                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function: get-extracted-data-backend                       â”‚
â”‚ Location: /supabase/functions/get-extracted-data-backend        â”‚
â”‚                                                                  â”‚
â”‚ SQL Queries:                                                     â”‚
â”‚ 1. Get document:                                                 â”‚
â”‚    SELECT * FROM documents WHERE id = $1 AND user_id = $2       â”‚
â”‚                                                                  â”‚
â”‚ 2. Get fields with extracted data:                              â”‚
â”‚    SELECT                                                        â”‚
â”‚      df.id as field_id,                                         â”‚
â”‚      df.name as field_name,                                     â”‚
â”‚      df.type as field_type,                                     â”‚
â”‚      df.description as field_description,                       â”‚
â”‚      ed.id as extracted_id,                                     â”‚
â”‚      ed.value,                                                  â”‚
â”‚      ed.confidence                                              â”‚
â”‚    FROM document_fields df                                      â”‚
â”‚    LEFT JOIN extracted_data ed                                  â”‚
â”‚      ON df.id = ed.field_id                                     â”‚
â”‚    WHERE df.document_id = $1                                    â”‚
â”‚    ORDER BY df.created_at ASC                                   â”‚
â”‚                                                                  â”‚
â”‚ Returns: { document, extractedFields }                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Display document details                                â”‚
â”‚                                                                  â”‚
â”‚ UI Components:                                                   â”‚
â”‚ - Document header (name, status, created date)                  â”‚
â”‚ - Action buttons (Download, Delete)                             â”‚
â”‚ - Add new field form                                            â”‚
â”‚ - Extracted fields list (cards)                                 â”‚
â”‚ - Document info sidebar (metadata)                              â”‚
â”‚                                                                  â”‚
â”‚ Each field card shows:                                          â”‚
â”‚ - Field name and type badge                                     â”‚
â”‚ - Extracted value                                               â”‚
â”‚ - Confidence score (if available)                               â”‚
â”‚ - Edit button                                                   â”‚
â”‚ - Delete button                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4A. Add New Field to Existing Document

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User enters field name and type, clicks "Add Field"             â”‚
â”‚ Function: handleAddField(e)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: Create field record                                     â”‚
â”‚ SQL: INSERT INTO document_fields                                â”‚
â”‚      (document_id, name, type, description)                     â”‚
â”‚      VALUES ($1, $2, $3, $4)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Show "Processing..." in UI                              â”‚
â”‚ Add temporary field to state with value = "Processing..."       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Get document public URL                                 â”‚
â”‚ Function: supabase.storage.from('documents')                    â”‚
â”‚          .getPublicUrl(storagePath)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Call process-document-backend                           â”‚
â”‚ Parameters:                                                      â”‚
â”‚ - documentId (existing)                                         â”‚
â”‚ - documentName                                                  â”‚
â”‚ - filePath                                                      â”‚
â”‚ - publicUrl                                                     â”‚
â”‚ - fieldsToExtract: [{ name, type, description }]               â”‚
â”‚                                                                  â”‚
â”‚ This triggers Azure extraction for ONLY the new field           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Refresh data after processing                           â”‚
â”‚ Call fetchData() again to get updated extracted value           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4B. Rerun All Fields

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User clicks "Rerun Extraction" button                           â”‚
â”‚ Function: handleRerun()                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: Delete all existing extracted data                      â”‚
â”‚ SQL: DELETE FROM extracted_data                                 â”‚
â”‚      WHERE field_id IN (                                        â”‚
â”‚        SELECT id FROM document_fields                           â”‚
â”‚        WHERE document_id = $1                                   â”‚
â”‚      )                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Update document status to "processing"                  â”‚
â”‚ SQL: UPDATE documents SET status = 'processing'                 â”‚
â”‚      WHERE id = $1                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Get all fields for document                             â”‚
â”‚ SQL: SELECT name, type, description FROM document_fields        â”‚
â”‚      WHERE document_id = $1                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Call process-document-backend                           â”‚
â”‚ Parameters: ALL fields from document                            â”‚
â”‚                                                                  â”‚
â”‚ This re-extracts ALL fields from the document                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Refresh data to show new results                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4C. Edit Field Value

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User clicks "Edit" button on a field                            â”‚
â”‚ Opens FieldValidationModal component                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Modal shows:                                                     â”‚
â”‚ - Field name (read-only)                                        â”‚
â”‚ - Current value (editable input)                                â”‚
â”‚ - Confidence score (if available)                               â”‚
â”‚ - Save/Cancel buttons                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User modifies value and clicks "Save"                           â”‚
â”‚ Function: handleSaveField(fieldId, newValue)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UPSERT into extracted_data                                      â”‚
â”‚ SQL: INSERT INTO extracted_data                                 â”‚
â”‚      (field_id, document_id, value, confidence)                 â”‚
â”‚      VALUES ($1, $2, $3, NULL)                                  â”‚
â”‚      ON CONFLICT (field_id, document_id)                        â”‚
â”‚      DO UPDATE SET value = $3, confidence = NULL                â”‚
â”‚                                                                  â”‚
â”‚ Note: confidence = NULL indicates manual edit                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update UI to reflect new value                                  â”‚
â”‚ Close modal                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Files Involved:**
- `/app/documents/[id]/page.tsx` - Document detail page
- `/components/field-validation-modal.tsx` - Edit modal
- `/supabase/functions/get-extracted-data-backend/index.ts` - Data retrieval

**Key Functions:**

1. **Document Detail Page:**
   - `fetchData()` - Loads document and fields
   - `handleAddField()` - Adds new field with extraction
   - `handleRerun()` - Re-extracts all fields
   - `handleSaveField()` - Updates field value
   - `handleDeleteField()` - Removes field
   - `handleDelete()` - Deletes entire document

---

### 5. Theme Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Application loads with ThemeProvider                            â”‚
â”‚ Location: /app/layout.tsx                                       â”‚
â”‚                                                                  â”‚
â”‚ <ThemeProvider                                                  â”‚
â”‚   attribute="class"                                             â”‚
â”‚   defaultTheme="system"                                         â”‚
â”‚   enableSystem                                                  â”‚
â”‚   disableTransitionOnChange                                     â”‚
â”‚ >                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ThemeToggle component in Navbar                                 â”‚
â”‚ Component: /components/theme-toggle.tsx                         â”‚
â”‚                                                                  â”‚
â”‚ Hook: useTheme() from next-themes                               â”‚
â”‚ State: theme (current: "light" | "dark" | "system")            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                               â–¼
  User clicks toggle           Theme changes
         â”‚                               â”‚
         â–¼                               â–¼
  setTheme(newTheme)          <html class="dark">
         â”‚                     or <html class="light">
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ CSS variables update   â”‚
           â”‚ from globals.css       â”‚
           â”‚                        â”‚
           â”‚ .dark { ... }         â”‚
           â”‚ :root { ... }         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ All colors re-apply    â”‚
           â”‚ Icons animate          â”‚
           â”‚ (Sun â†” Moon)          â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Files Involved:**
- `/components/theme-provider.tsx` - Theme context provider
- `/components/theme-toggle.tsx` - Toggle button component
- `/app/globals.css` - Theme CSS variables
- `/app/layout.tsx` - Provider wrapper

---

### 6. Session Management & Security Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Activity Detection                                         â”‚
â”‚ Hook: useSessionManager()                                       â”‚
â”‚ Location: /lib/hooks.ts                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Monitors user activity:                                         â”‚
â”‚ - Mouse movement                                                 â”‚
â”‚ - Keyboard input                                                â”‚
â”‚ - Touch events                                                  â”‚
â”‚                                                                  â”‚
â”‚ Timers:                                                         â”‚
â”‚ - Warning timeout: 25 minutes of inactivity                     â”‚
â”‚ - Logout timeout: 30 minutes of inactivity                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                               â–¼
  Activity detected              No activity for 25min
         â”‚                               â”‚
  Reset timers                    Show warning modal
         â”‚                               â”‚
         â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                      â–¼                 â–¼
         â”‚            User clicks "Stay"    5min countdown
         â”‚            Reset timers          No interaction
         â”‚                                        â”‚
         â”‚                                        â–¼
         â”‚                              Sign out user
         â”‚                              Redirect to /auth/login
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Files Involved:**
- `/lib/hooks.ts` - useSessionManager hook
- `/components/session-warning-modal.tsx` - Warning dialog

---

### 7. Middleware & Route Protection

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User navigates to any page                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Middleware executes (middleware.ts)                             â”‚
â”‚                                                                  â”‚
â”‚ Protected routes:                                               â”‚
â”‚ - /dashboard                                                    â”‚
â”‚ - /documents/*                                                  â”‚
â”‚ - /extract                                                      â”‚
â”‚ - /account/*                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                               â–¼
  Public route                    Protected route
  Allow access                           â”‚
         â”‚                               â–¼
         â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚ Check session cookie â”‚
         â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                            â”‚
         â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â–¼                      â–¼
         â”‚          Session valid         No session
         â”‚          Allow access          Redirect to
         â”‚                â”‚               /auth/login
         â”‚                â”‚                      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Render requested pageâ”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Files Involved:**
- `/middleware.ts` - Route protection logic
- `/lib/server.ts` - Server-side Supabase client with cookies

## ğŸ“‹ Database Schema & Relations

### Complete Entity-Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   auth.users    â”‚ (Supabase Auth - managed by Supabase)
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (UUID)       â”‚â”€â”€â”€â”
â”‚ email           â”‚   â”‚
â”‚ created_at      â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                      â”‚
                      â”‚ 1:1
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       profiles              â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (UUID) PK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ Foreign Key â†’ auth.users(id)
â”‚ username (VARCHAR)          â”‚
â”‚ full_name (TEXT)            â”‚
â”‚ avatar_url (TEXT)           â”‚
â”‚ created_at (TIMESTAMPTZ)    â”‚
â”‚ updated_at (TIMESTAMPTZ)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       documents             â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (UUID) PK                â”‚
â”‚ user_id (UUID) FK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ Foreign Key â†’ profiles(id)
â”‚ name (TEXT)                 â”‚
â”‚ storage_path (TEXT)         â”‚â”€â”€â”€ Path: {user_id}/{filename}
â”‚ status (VARCHAR)            â”‚â”€â”€â”€ Values: processing, completed, failed
â”‚ created_at (TIMESTAMPTZ)    â”‚
â”‚ processed_at (TIMESTAMPTZ)  â”‚â”€â”€â”€ Auto-set by trigger
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    document_fields          â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (UUID) PK                â”‚
â”‚ document_id (UUID) FK â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ Foreign Key â†’ documents(id)
â”‚ name (TEXT)                 â”‚â”€â”€â”€ Field identifier
â”‚ type (VARCHAR)              â”‚â”€â”€â”€ text, number, date, email, phone,
â”‚ description (TEXT)          â”‚    currency, boolean
â”‚ created_at (TIMESTAMPTZ)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:1 or 1:0
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     extracted_data          â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (UUID) PK                â”‚
â”‚ field_id (UUID) FK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ Foreign Key â†’ document_fields(id)
â”‚ document_id (UUID) FK â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ Foreign Key â†’ documents(id)
â”‚ value (TEXT)                â”‚â”€â”€â”€ Extracted/edited value
â”‚ confidence (NUMERIC)        â”‚â”€â”€â”€ AI confidence (0-1), NULL if manual
â”‚ created_at (TIMESTAMPTZ)    â”‚
â”‚ updated_at (TIMESTAMPTZ)    â”‚
â”‚                             â”‚
â”‚ UNIQUE(field_id,            â”‚
â”‚        document_id)         â”‚â”€â”€â”€ Prevents duplicate extractions
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Table Details

#### 1. `profiles`
**Purpose**: Store user profile information
**RLS Policy**: Users can only read/update their own profile
**Trigger**: Auto-created on user signup via `handle_new_user()`

```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  username VARCHAR(24) UNIQUE,
  full_name TEXT,
  avatar_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**RLS Policies:**
- SELECT: `auth.uid() = id`
- UPDATE: `auth.uid() = id`
- INSERT: `auth.uid() = id`

---

#### 2. `documents`
**Purpose**: Store document metadata and processing status
**RLS Policy**: Users can only access their own documents
**Cascade**: Deleting a document deletes all related fields and extracted data

```sql
CREATE TABLE documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  storage_path TEXT NOT NULL,
  status VARCHAR(20) DEFAULT 'processing',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  processed_at TIMESTAMPTZ
);
```

**Status Values:**
- `processing` - Document is being analyzed
- `completed` - Extraction successful
- `failed` - Extraction failed

**RLS Policies:**
- SELECT: `auth.uid() = user_id`
- INSERT: `auth.uid() = user_id`
- UPDATE: `auth.uid() = user_id`
- DELETE: `auth.uid() = user_id`

**Indexes:**
- `idx_documents_user_id` ON (user_id)
- `idx_documents_status` ON (status)

---

#### 3. `document_fields`
**Purpose**: Define which fields to extract from each document
**RLS Policy**: Users can only access fields for their own documents
**Cascade**: Deleting a field deletes its extracted data

```sql
CREATE TABLE document_fields (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  document_id UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  type VARCHAR(50) DEFAULT 'text',
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Field Types:**
- `text` - General text (default)
- `number` - Numeric values
- `currency` - Monetary amounts
- `date` - Date values
- `email` - Email addresses
- `phone` - Phone numbers
- `boolean` - Yes/No, True/False

**RLS Policies:**
- SELECT: `EXISTS (SELECT 1 FROM documents d WHERE d.id = document_id AND d.user_id = auth.uid())`
- INSERT: `EXISTS (SELECT 1 FROM documents d WHERE d.id = document_id AND d.user_id = auth.uid())`
- DELETE: `EXISTS (SELECT 1 FROM documents d WHERE d.id = document_id AND d.user_id = auth.uid())`

**Indexes:**
- `idx_document_fields_document_id` ON (document_id)

---

#### 4. `extracted_data`
**Purpose**: Store AI-extracted or manually-entered field values
**RLS Policy**: Users can only access data for their own documents
**Constraint**: One value per field per document (UNIQUE constraint)

```sql
CREATE TABLE extracted_data (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  field_id UUID NOT NULL REFERENCES document_fields(id) ON DELETE CASCADE,
  document_id UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
  value TEXT,
  confidence NUMERIC(5,4),  -- 0.0000 to 1.0000
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(field_id, document_id)
);
```

**Confidence Score:**
- `0.0 - 1.0` - AI extraction confidence
- `NULL` - Manually edited value

**RLS Policies:**
- SELECT: `EXISTS (SELECT 1 FROM documents d WHERE d.id = document_id AND d.user_id = auth.uid())`
- INSERT: `EXISTS (SELECT 1 FROM documents d WHERE d.id = document_id AND d.user_id = auth.uid())`
- UPDATE: `EXISTS (SELECT 1 FROM documents d WHERE d.id = document_id AND d.user_id = auth.uid())`
- DELETE: `EXISTS (SELECT 1 FROM documents d WHERE d.id = document_id AND d.user_id = auth.uid())`

**Indexes:**
- `idx_extracted_data_field_id` ON (field_id)
- `idx_extracted_data_document_id` ON (document_id)

---

### Database Triggers

#### 1. `handle_new_user()`
**Purpose**: Auto-create profile when user signs up
**Trigger**: `on_auth_user_created` (Supabase Auth event)
**When**: AFTER INSERT ON auth.users

```sql
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, username, full_name, avatar_url)
  VALUES (
    NEW.id,
    COALESCE(NEW.raw_user_meta_data->>'username', split_part(NEW.email, '@', 1)),
    COALESCE(NEW.raw_user_meta_data->>'full_name', NEW.raw_user_meta_data->>'name'),
    NEW.raw_user_meta_data->>'avatar_url'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**What it does:**
1. Extracts metadata from OAuth or signup form
2. Creates profile record with same UUID as auth.users
3. Sets username (from metadata or email prefix)
4. Sets full_name and avatar_url if available

---

#### 2. `update_document_processed_at()`
**Purpose**: Auto-set processed_at timestamp when document completes
**Trigger**: `document_processed_at_trigger`
**When**: AFTER UPDATE ON documents (when status changes to 'completed')

```sql
CREATE OR REPLACE FUNCTION update_document_processed_at()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.status = 'completed' AND OLD.status != 'completed' THEN
    NEW.processed_at = NOW();
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**What it does:**
1. Monitors status column changes
2. When status becomes 'completed', sets processed_at to current timestamp
3. Only triggers on status change (not on subsequent updates)

---

### Storage Buckets

#### `documents` Bucket

**Purpose**: Store uploaded PDF and image files
**Access**: Public (required for Azure Document Intelligence to access files)
**Path Structure**: `{user_id}/{filename}`

**Configuration:**
```sql
INSERT INTO storage.buckets (id, name, public)
VALUES ('documents', 'documents', true);
```

**RLS Policies:**
- **INSERT**: Users can only upload to their own folder
  ```sql
  (bucket_id = 'documents' AND (storage.foldername(name))[1] = auth.uid()::text)
  ```

- **SELECT**: Users can only view their own files
  ```sql
  (bucket_id = 'documents' AND (storage.foldername(name))[1] = auth.uid()::text)
  ```

- **DELETE**: Users can only delete their own files
  ```sql
  (bucket_id = 'documents' AND (storage.foldername(name))[1] = auth.uid()::text)
  ```

**File Types Accepted:**
- PDF: `application/pdf`
- Images: `image/png`, `image/jpeg`, `image/jpg`

**Size Limit**: 50MB per file (enforced in client-side validation)

## ğŸš€ Getting Started

### Prerequisites
- Node.js 18+ and npm
- Supabase account (https://supabase.com)
- Azure Document Intelligence resource
- Supabase CLI: `npm install -g supabase`

### 1. Clone & Install

```bash
git clone <repo-url>
cd DocExt
npm install
```

### 2. Setup Supabase

```bash
# Login to Supabase
npm run supabase:login

# Link to your project
npm run supabase:link --project-ref <your-project-ref>
```

### 3. Setup Database

Run the SQL setup in Supabase SQL Editor:

1. Go to Supabase Dashboard â†’ Project â†’ SQL Editor
2. Copy contents of `DATABASE_SETUP.sql`
3. Paste and run in SQL Editor
4. Verify tables were created

```bash
# Alternatively, use Supabase CLI
supabase db push
```

### 4. Configure Secrets

Set Edge Function secrets in Supabase:

```bash
supabase secrets set \
  AZURE_DOCUMENT_INTELLIGENCE_ENDPOINT=https://your-region.cognitiveservices.azure.com/ \
  AZURE_DOCUMENT_INTELLIGENCE_API_KEY=your_api_key \
  AZURE_DOCUMENT_INTELLIGENCE_MODEL_ID=prebuilt-invoice \
  GEMINI_API_KEY=your_gemini_key
```

### 5. Environment Variables

Create `.env.local`:

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key

# Development (optional)
NEXT_PUBLIC_DEV_SUPABASE_REDIRECT_URL=http://localhost:3000/dashboard
```

### 6. Run Development Server

```bash
npm run dev
```

Open [http://localhost:3000](http://localhost:3000)

## ğŸ“‹ Available Commands

### Development
```bash
npm run dev              # Start Next.js dev server (http://localhost:3000)
npm run build            # Build for production
npm run start            # Start production server
npm run lint             # Check code quality with ESLint
```

### Supabase
```bash
npm run supabase:login   # Login to Supabase CLI
npm run supabase:link    # Link to Supabase project
npm run supabase:start   # Start local Supabase instance
npm run supabase:stop    # Stop local Supabase instance
```

### Edge Functions
```bash
npm run functions:serve      # Serve functions locally
npm run functions:deploy     # Deploy all functions to production
npm run functions:deploy:upload    # Deploy only upload function
npm run functions:deploy:process   # Deploy only process function
npm run functions:deploy:data      # Deploy only data retrieval function
npm run functions:logs       # View function logs
```

### Secrets
```bash
npm run secrets:set          # Set Edge Function secrets
```

## ğŸ” Security

### Authentication
- Email/password authentication via Supabase Auth
- OAuth providers: Google, GitHub
- JWT tokens for API requests
- Session management via Supabase

### Database Security
- Row-Level Security (RLS) enabled on all tables
- Users can only access their own documents
- Policies prevent cross-user data access
- Automatic cascading deletes

### Storage Security
- User-scoped paths: `{user_id}/{filename}`
- Private by default, public only for Azure processing
- Signed URLs for uploads (5-minute expiry)
- Middleware protects routes

### API Security
- Edge functions verify JWT tokens
- CORS headers configured
- Secrets stored securely (not in code)
- No sensitive data in client code

## ğŸ“ Project Structure

```
DocExt/
â”œâ”€â”€ app/                                          # Next.js App Router
â”‚   â”œâ”€â”€ page.tsx                                 # Landing page (home)
â”‚   â”œâ”€â”€ layout.tsx                               # Root layout with ThemeProvider
â”‚   â”œâ”€â”€ globals.css                              # Global styles + dark mode
â”‚   â”‚
â”‚   â”œâ”€â”€ auth/                                    # Authentication pages
â”‚   â”‚   â”œâ”€â”€ login/page.tsx                      # Email + OAuth login
â”‚   â”‚   â”œâ”€â”€ sign-up/page.tsx                    # Registration form
â”‚   â”‚   â”œâ”€â”€ confirm/page.tsx                    # Email confirmation page
â”‚   â”‚   â”œâ”€â”€ sign-up-success/page.tsx            # Post-signup message
â”‚   â”‚   â”œâ”€â”€ forgot-password/page.tsx            # Password reset request
â”‚   â”‚   â”œâ”€â”€ reset-password/page.tsx             # New password form
â”‚   â”‚   â””â”€â”€ callback/route.ts                   # OAuth redirect handler
â”‚   â”‚
â”‚   â”œâ”€â”€ dashboard/                               # Main dashboard
â”‚   â”‚   â”œâ”€â”€ page.tsx                            # Server component wrapper
â”‚   â”‚   â”œâ”€â”€ dashboard-content.tsx               # Client component UI
â”‚   â”‚   â””â”€â”€ loading.tsx                         # Skeleton loading state
â”‚   â”‚
â”‚   â”œâ”€â”€ documents/                               # Document management
â”‚   â”‚   â”œâ”€â”€ page.tsx                            # Documents list page
â”‚   â”‚   â”œâ”€â”€ loading.tsx                         # List loading skeleton
â”‚   â”‚   â””â”€â”€ [id]/                               # Dynamic document detail
â”‚   â”‚       â”œâ”€â”€ page.tsx                        # Detail page with fields
â”‚   â”‚       â””â”€â”€ loading.tsx                     # Detail loading skeleton
â”‚   â”‚
â”‚   â”œâ”€â”€ extract/page.tsx                         # Document upload flow
â”‚   â”œâ”€â”€ account/profile/                         # User profile
â”‚   â”‚   â”œâ”€â”€ page.tsx                            # Profile settings
â”‚   â”‚   â””â”€â”€ loading.tsx                         # Profile loading skeleton
â”‚   â”‚
â”‚   â”œâ”€â”€ privacy/page.tsx                         # Privacy policy
â”‚   â”œâ”€â”€ terms/page.tsx                           # Terms of service
â”‚   â””â”€â”€ api/env-check/route.ts                   # Environment check endpoint
â”‚
â”œâ”€â”€ components/                                   # React components
â”‚   â”œâ”€â”€ navbar.tsx                               # Main navigation
â”‚   â”œâ”€â”€ document-card.tsx                        # Document grid item
â”‚   â”œâ”€â”€ document-card-skeleton.tsx               # Loading placeholder
â”‚   â”œâ”€â”€ field-validation-modal.tsx               # Edit field modal
â”‚   â”œâ”€â”€ home-sections.tsx                        # Landing page sections
â”‚   â”œâ”€â”€ auth-form.tsx                            # Reusable auth form
â”‚   â”œâ”€â”€ session-warning-modal.tsx                # Session timeout warning
â”‚   â”œâ”€â”€ theme-provider.tsx                       # next-themes wrapper
â”‚   â”œâ”€â”€ theme-toggle.tsx                         # Dark/light mode toggle
â”‚   â”œâ”€â”€ skeletons.tsx                            # Various loading skeletons
â”‚   â”‚
â”‚   â””â”€â”€ ui/                                      # Shadcn UI primitives
â”‚       â”œâ”€â”€ button.tsx                           # Button component
â”‚       â”œâ”€â”€ card.tsx                             # Card component
â”‚       â”œâ”€â”€ input.tsx                            # Input component
â”‚       â”œâ”€â”€ label.tsx                            # Label component
â”‚       â”œâ”€â”€ dialog.tsx                           # Modal dialog
â”‚       â”œâ”€â”€ dropdown-menu.tsx                    # Dropdown component
â”‚       â””â”€â”€ skeleton.tsx                         # Skeleton loader
â”‚
â”œâ”€â”€ lib/                                          # Utility libraries
â”‚   â”œâ”€â”€ client.ts                                # Supabase client (browser)
â”‚   â”œâ”€â”€ server.ts                                # Supabase client (server)
â”‚   â”œâ”€â”€ edge-functions.ts                        # Edge function helpers
â”‚   â”œâ”€â”€ hooks.ts                                 # Custom React hooks
â”‚   â”œâ”€â”€ validations.ts                           # Zod schemas
â”‚   â””â”€â”€ utils.ts                                 # Utility functions (cn, etc)
â”‚
â”œâ”€â”€ supabase/                                     # Supabase configuration
â”‚   â”œâ”€â”€ config.toml                              # Local Supabase config
â”‚   â”‚
â”‚   â””â”€â”€ functions/                               # Edge Functions (Deno)
â”‚       â”œâ”€â”€ upload-document-backend/
â”‚       â”‚   â””â”€â”€ index.ts                         # Generate signed upload URLs
â”‚       â”‚
â”‚       â”œâ”€â”€ process-document-backend/
â”‚       â”‚   â””â”€â”€ index.ts                         # Azure AI processing
â”‚       â”‚                                        # - Call Azure API
â”‚       â”‚                                        # - Poll for results
â”‚       â”‚                                        # - Save to database
â”‚       â”‚
â”‚       â”œâ”€â”€ get-extracted-data-backend/
â”‚       â”‚   â””â”€â”€ index.ts                         # Fetch document + fields
â”‚       â”‚
â”‚       â””â”€â”€ _shared/
â”‚           â””â”€â”€ cors.ts                          # CORS utility
â”‚
â”œâ”€â”€ middleware.ts                                 # Route protection
â”œâ”€â”€ DATABASE_SETUP.sql                            # Complete DB schema
â”œâ”€â”€ .env.local                                    # Environment variables
â”œâ”€â”€ package.json                                  # Dependencies & scripts
â”œâ”€â”€ tsconfig.json                                 # TypeScript config
â”œâ”€â”€ next.config.ts                                # Next.js config
â”œâ”€â”€ tailwind.config.ts                            # Tailwind config
â””â”€â”€ components.json                               # Shadcn UI config
```

---

## ğŸŒ API Reference

### Edge Functions (Supabase)

All Edge Functions require authentication via JWT token in the `Authorization` header.

#### 1. `upload-document-backend`

**Purpose**: Generate a signed upload URL for Supabase Storage

**Endpoint**: `POST /functions/v1/upload-document-backend`

**Request Body:**
```typescript
{
  fileName: string      // Original filename
  fileType: string      // MIME type (e.g., "application/pdf")
  fileSize: number      // File size in bytes
}
```

**Response:**
```typescript
{
  uploadUrl: string     // Signed URL for PUT upload (5min expiry)
  filePath: string      // Storage path: {user_id}/{unique_filename}
  publicUrl: string     // Public HTTPS URL for the file
}
```

**Client Usage:**
```typescript
import { uploadDocument } from '@/lib/edge-functions'

const { data, error } = await uploadDocument(file, documentName)
if (data) {
  console.log('File uploaded to:', data.filePath)
  console.log('Public URL:', data.publicUrl)
}
```

**Process Flow:**
1. Validates user authentication
2. Generates unique filename with timestamp
3. Creates storage path: `{user_id}/{timestamp}_{filename}`
4. Generates signed upload URL (5-minute expiry)
5. Gets public URL for the file
6. Returns all URLs to client

**Error Responses:**
- `401 Unauthorized` - Missing or invalid JWT token
- `400 Bad Request` - Missing required fields
- `500 Internal Server Error` - Storage service error

---

#### 2. `process-document-backend`

**Purpose**: Process document with Azure Document Intelligence and save results

**Endpoint**: `POST /functions/v1/process-document-backend`

**Request Body:**
```typescript
{
  documentId?: string                    // Optional: existing document ID
  documentName: string                   // Document name/title
  filePath: string                       // Storage path from upload
  publicUrl: string                      // Public HTTPS URL
  fieldsToExtract: Array<{              // Fields to extract
    name: string                         // Field identifier
    type?: string                        // Field type (default: 'text')
    description?: string                 // Field description
  }> | string[]                          // Can also be simple string array
}
```

**Response:**
```typescript
{
  documentId: string                     // Created/updated document ID
  status: string                         // Processing status
  extractedFields: Array<{
    fieldName: string
    value: string
    confidence: number                   // 0.0 - 1.0
  }>
}
```

**Client Usage:**
```typescript
import { processDocument } from '@/lib/edge-functions'

const { data, error } = await processDocument({
  documentName: 'Invoice-2024',
  filePath: 'user-id/invoice.pdf',
  publicUrl: 'https://...',
  fieldsToExtract: [
    { name: 'InvoiceId', type: 'text', description: 'Invoice number' },
    { name: 'InvoiceTotal', type: 'currency', description: 'Total amount' },
    { name: 'InvoiceDate', type: 'date', description: 'Invoice date' }
  ]
})
```

**Process Flow:**
1. Validates user authentication
2. Creates/updates document record (status: 'processing')
3. Inserts field definitions into document_fields table
4. Calls Azure Document Intelligence API
5. Polls operation URL for results (max 60 attempts, 1s intervals)
6. Extracts field values from Azure response
7. Saves to extracted_data table with confidence scores
8. Updates document status to 'completed' or 'failed'
9. Returns results

**Azure Integration:**
- API: Azure Document Intelligence REST API v2024-02-29-preview
- Model: prebuilt-invoice (configurable via env var)
- Timeout: 60 seconds maximum polling
- Polling Interval: 1 second

**Error Responses:**
- `401 Unauthorized` - Missing or invalid JWT token
- `400 Bad Request` - Missing required fields
- `500 Internal Server Error` - Azure API error or database error
- `408 Request Timeout` - Azure processing exceeded 60s

---

#### 3. `get-extracted-data-backend`

**Purpose**: Retrieve document metadata and all extracted field values

**Endpoint**: `POST /functions/v1/get-extracted-data-backend`

**Request Body:**
```typescript
{
  documentId: string                     // Document UUID
}
```

**Response:**
```typescript
{
  document: {
    id: string
    name: string
    storagePath: string
    status: string                       // 'processing' | 'completed' | 'failed'
    createdAt: string                    // ISO 8601 timestamp
    processedAt: string | null           // ISO 8601 timestamp
  },
  extractedFields: Array<{
    id: string                           // Extracted data record ID
    fieldId: string                      // Field definition ID
    fieldName: string                    // Field name
    fieldType: string                    // Field type
    fieldDescription: string             // Field description
    value: string                        // Extracted/edited value
    confidence: number | null            // AI confidence (null if manual edit)
  }>
}
```

**Client Usage:**
```typescript
import { getExtractedData } from '@/lib/edge-functions'

const { data, error } = await getExtractedData(documentId)
if (data) {
  console.log('Document:', data.document.name)
  console.log('Fields:', data.extractedFields)
}
```

**Process Flow:**
1. Validates user authentication
2. Fetches document record (with user_id check via RLS)
3. Fetches all fields for document
4. LEFT JOINs with extracted_data to include values
5. Returns formatted response

**SQL Query:**
```sql
SELECT 
  df.id as field_id,
  df.name as field_name,
  df.type as field_type,
  df.description as field_description,
  ed.id as extracted_id,
  ed.value,
  ed.confidence
FROM document_fields df
LEFT JOIN extracted_data ed ON df.id = ed.field_id
WHERE df.document_id = $1
ORDER BY df.created_at ASC
```

**Error Responses:**
- `401 Unauthorized` - Missing or invalid JWT token
- `404 Not Found` - Document not found or belongs to different user
- `500 Internal Server Error` - Database error

---

### Client-Side API Functions

Located in `/lib/edge-functions.ts`

#### `callEdgeFunction<T>(functionName: string, payload: any)`

Generic helper for calling any Supabase Edge Function with authentication.

**Returns:** `Promise<{ data?: T; error?: string }>`

**Features:**
- Automatic JWT token injection
- Error handling
- Type-safe responses

---

#### `uploadDocument(file: File, documentName: string)`

Uploads a file to Supabase Storage via the upload-document-backend edge function.

**Returns:** `Promise<{ data?: { filePath: string; publicUrl: string }; error?: string }>`

---

#### `processDocument(params: ProcessParams)`

Processes a document with Azure Document Intelligence.

**Returns:** `Promise<{ data?: ProcessResponse; error?: string }>`

---

#### `getExtractedData(documentId: string)`

Fetches document details and extracted field values.

**Returns:** `Promise<{ data?: DocumentData; error?: string }>`

## ğŸ“ Environment Setup

### Local Development
```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Production
```bash
# .env.production
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
```

## ğŸš€ Deployment

### Frontend (Vercel/Netlify)
```bash
npm run build
# Deploy the .next folder to Vercel/Netlify
```

### Edge Functions (Supabase)
```bash
npm run functions:deploy
```

### Database
```bash
# Migrations are auto-applied via Supabase
supabase db push
```

## ğŸ› Troubleshooting

### Database Connection Issues
- Verify Supabase project is running
- Check `NEXT_PUBLIC_SUPABASE_URL` and anon key
- Run `npm run supabase:link` to link project

### Edge Function Errors
- Check logs: `npm run functions:logs`
- Verify secrets are set: `supabase secrets list`
- Test locally: `npm run functions:serve`

### Document Upload Issues
- Check file size (max 50MB)
- Verify storage bucket exists
- Check RLS policies on storage

### Azure Intelligence Errors
- Verify endpoint URL format
- Check API key is valid
- Confirm model ID is correct (prebuilt-invoice)

## ğŸ“š Resources

- [Next.js Documentation](https://nextjs.org/docs)
- [Supabase Documentation](https://supabase.com/docs)
- [Azure Document Intelligence](https://learn.microsoft.com/en-us/azure/ai-services/document-intelligence/)
- [Tailwind CSS](https://tailwindcss.com)
- [TypeScript](https://www.typescriptlang.org)

## ğŸ“„ License

Private and Proprietary

## ğŸ‘¥ Support

For issues, questions, or contributions, contact the development team.


